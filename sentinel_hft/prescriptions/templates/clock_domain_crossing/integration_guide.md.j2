# Integration Guide: Asynchronous FIFO

> **Generated by Sentinel-HFT FixPack Generator**
> Pattern: CLOCK_DOMAIN_CROSSING
> Generated: {{ metadata.generation_timestamp }}

## Overview

This fix addresses **clock domain crossing** issues by implementing a properly synchronized asynchronous FIFO with gray-coded pointers.

### Problem Statement

{{ metadata.problem_statement }}

### Solution Approach

{{ metadata.solution_approach }}

## Parameters Used

| Parameter | Value | Description |
|-----------|-------|-------------|
| DATA_WIDTH | {{ params.DATA_WIDTH }} | Data path width |
| DEPTH | {{ params.DEPTH }} | FIFO depth (power of 2) |
| SYNC_STAGES | {{ params.SYNC_STAGES }} | Synchronizer stages |
| ALMOST_FULL_THRESHOLD | {{ params.ALMOST_FULL_THRESHOLD }} | Early full warning |
| ALMOST_EMPTY_THRESHOLD | {{ params.ALMOST_EMPTY_THRESHOLD }} | Early empty warning |
| OUTPUT_REG | {{ params.OUTPUT_REG }} | Register output |

## Expected Impact

- **Latency**: {{ params.SYNC_STAGES }} + 1 cycles minimum
- **Metastability MTBF**: > 100 years at 500MHz with {{ params.SYNC_STAGES }} stages

## Integration Steps

### Step 1: Replace Existing CDC

```systemverilog
// Before (potentially unsafe):
// always @(posedge fast_clk) data_sync <= slow_domain_data;

// After (safe async FIFO):
async_fifo #(
    .DATA_WIDTH({{ params.DATA_WIDTH }}),
    .DEPTH({{ params.DEPTH }}),
    .SYNC_STAGES({{ params.SYNC_STAGES }}),
    .ALMOST_FULL_THRESHOLD({{ params.ALMOST_FULL_THRESHOLD }}),
    .ALMOST_EMPTY_THRESHOLD({{ params.ALMOST_EMPTY_THRESHOLD }}),
    .OUTPUT_REG({{ '1' if params.OUTPUT_REG else '0' }})
) u_cdc_fifo (
    // Write domain (source)
    .wr_clk(src_clk),
    .wr_rst_n(src_rst_n),
    .wr_data(src_data),
    .wr_en(src_valid),
    .wr_full(src_backpressure),
    .wr_almost_full(src_flow_control),

    // Read domain (destination)
    .rd_clk(dst_clk),
    .rd_rst_n(dst_rst_n),
    .rd_data(dst_data),
    .rd_en(dst_ready),
    .rd_empty(dst_not_valid),
    .rd_almost_empty(dst_flow_hint),

    .wr_fill_level(debug_fill)
);
```

### Step 2: Synthesis Constraints

Add timing exceptions and ASYNC_REG attributes:

```tcl
# Xilinx Vivado
set_property ASYNC_REG TRUE [get_cells u_cdc_fifo/*_meta_reg*]
set_max_delay -datapath_only -from [get_clocks src_clk] -to [get_clocks dst_clk] {{ 1000 / metadata.fpga_resources[0].max_freq_mhz * 2 }}
set_max_delay -datapath_only -from [get_clocks dst_clk] -to [get_clocks src_clk] {{ 1000 / metadata.fpga_resources[0].max_freq_mhz * 2 }}

# Intel Quartus
set_instance_assignment -name SYNCHRONIZER_IDENTIFICATION AUTO -to *cdc_fifo*meta*
set_false_path -from [get_clocks src_clk] -to [get_registers *cdc_fifo*_meta[0]*]
set_false_path -from [get_clocks dst_clk] -to [get_registers *cdc_fifo*_meta[0]*]
```

### Step 3: Reset Synchronization

Ensure reset is properly synchronized to both domains:

```systemverilog
// Reset synchronizer for read domain
logic [1:0] rd_rst_sync;
always_ff @(posedge rd_clk or negedge async_rst_n) begin
    if (!async_rst_n)
        rd_rst_sync <= 2'b00;
    else
        rd_rst_sync <= {rd_rst_sync[0], 1'b1};
end
assign rd_rst_n = rd_rst_sync[1];
```

### Step 4: Flow Control

Use almost_full for producer-side flow control:

```systemverilog
// In write domain - stop before actually full
assign producer_can_send = !wr_almost_full;

// In read domain - consumer flow control
assign consumer_data_available = !rd_empty;
```

## CDC Verification

Run CDC analysis tools to verify:

```bash
# Synopsys SpyGlass CDC
spyglass -goal cdc -design async_fifo

# Cadence JasperGold
verify -cdc async_fifo.sv
```

## Verification Checklist

- [ ] Gray code pointers verified (single bit changes)
- [ ] Synchronizers have ASYNC_REG attribute
- [ ] Full/empty flags tested at boundary conditions
- [ ] Data integrity verified with random traffic
- [ ] Different clock ratios tested (1:1, 2:1, 3:2, etc.)
- [ ] Reset behavior verified in both domains

## Common Issues

1. **Data corruption**: Ensure ASYNC_REG constraints are applied
2. **Stuck FIFO**: Verify reset synchronization
3. **False full**: Normal - gray code synchronization is conservative

---

**CANDIDATE FIX - Review Required Before Use**
