# Integration Guide: Elastic Buffer Fix

> **Generated by Sentinel-HFT FixPack Generator**
> Pattern: FIFO_BACKPRESSURE
> Generated: {{ metadata.generation_timestamp }}

## Overview

This fix addresses **FIFO backpressure** issues detected in your latency trace. The elastic buffer provides credit-based flow control to prevent producer stalls when downstream cannot accept data.

### Problem Statement

{{ metadata.problem_statement }}

### Solution Approach

{{ metadata.solution_approach }}

## Parameters Used

| Parameter | Value | Description |
|-----------|-------|-------------|
| BUFFER_DEPTH | {{ params.BUFFER_DEPTH }} | Number of entries in the buffer |
| DATA_WIDTH | {{ params.DATA_WIDTH }} | Width of data path in bits |
| CREDIT_THRESHOLD | {{ params.CREDIT_THRESHOLD }} | Credits to reserve for in-flight transactions |
| REGISTER_OUTPUT | {{ params.REGISTER_OUTPUT }} | Add output register stage |

## Expected Impact

- **Latency Reduction**: ~{{ metadata.expected_latency_reduction_pct }}%
- **Throughput Improvement**: ~{{ metadata.expected_throughput_improvement_pct }}%
- **Confidence Range**: {{ metadata.confidence_range[0] }}-{{ metadata.confidence_range[1] }}%

## Resource Estimates

{% for fpga in metadata.fpga_resources %}
### {{ fpga.vendor.value | title }} {{ fpga.family | title }}

| Resource | Count |
|----------|-------|
| LUTs | {{ fpga.luts }} |
| FFs | {{ fpga.ffs }} |
| BRAM 18K | {{ fpga.bram_18k }} |
| BRAM 36K | {{ fpga.bram_36k }} |
| Max Frequency | {{ fpga.max_freq_mhz }} MHz |
| Latency | {{ fpga.latency_cycles }} cycle(s) |

{% if fpga.notes %}
**Notes**: {{ fpga.notes }}
{% endif %}

{% endfor %}

## Integration Steps

### Step 1: Review Generated Files

Ensure you have all generated files:
- `elastic_buffer.sv` - RTL module
- `elastic_buffer_tb.sv` - Testbench

### Step 2: Instantiate the Module

Replace your existing FIFO with the elastic buffer:

```systemverilog
// Before (typical FIFO with ready/valid):
fifo #(.DEPTH({{ params.BUFFER_DEPTH }}), .WIDTH({{ params.DATA_WIDTH }})) u_fifo (
    .clk(clk),
    .rst_n(rst_n),
    .wr_data(producer_data),
    .wr_valid(producer_valid),
    .wr_ready(producer_ready),  // May stall producer
    .rd_data(consumer_data),
    .rd_valid(consumer_valid),
    .rd_ready(consumer_ready)
);

// After (elastic buffer with credits):
elastic_buffer #(
    .DEPTH({{ params.BUFFER_DEPTH }}),
    .WIDTH({{ params.DATA_WIDTH }}),
    .CREDIT_THRESHOLD({{ params.CREDIT_THRESHOLD }}),
    .REGISTER_OUTPUT({{ '1' if params.REGISTER_OUTPUT else '0' }})
) u_elastic_buffer (
    .clk(clk),
    .rst_n(rst_n),
    .up_data(producer_data),
    .up_valid(producer_valid),
    .up_credit(producer_credit),  // Credit-based flow control
    .dn_data(consumer_data),
    .dn_valid(consumer_valid),
    .dn_ready(consumer_ready),
    .fill_level(buffer_fill_level),  // Optional monitoring
    .nearly_full(buffer_nearly_full),
    .nearly_empty(buffer_nearly_empty)
);
```

### Step 3: Update Producer Logic

Change from ready/valid to credit-based flow control:

```systemverilog
// Before:
always_ff @(posedge clk) begin
    if (producer_ready && have_data) begin
        producer_data <= next_data;
        producer_valid <= 1'b1;
    end else if (producer_ready) begin
        producer_valid <= 1'b0;
    end
    // Producer stalls when !producer_ready
end

// After:
always_ff @(posedge clk) begin
    if (producer_credit && have_data) begin
        producer_data <= next_data;
        producer_valid <= 1'b1;
    end else begin
        producer_valid <= 1'b0;
    end
    // No stall - credit signal is always combinational
end
```

### Step 4: Run Verification

1. Compile the testbench:
```bash
# Questa/ModelSim
vlog elastic_buffer.sv elastic_buffer_tb.sv
vsim -c elastic_buffer_tb -do "run -all; quit"

# VCS
vcs -sverilog elastic_buffer.sv elastic_buffer_tb.sv -o simv
./simv

# Vivado Simulator
xvlog --sv elastic_buffer.sv elastic_buffer_tb.sv
xelab elastic_buffer_tb -s sim
xsim sim -runall
```

2. Verify all tests pass
3. Check latency and throughput metrics in output

### Step 5: Synthesis Constraints

{% if params.REGISTER_OUTPUT %}
With REGISTER_OUTPUT enabled, timing should be relaxed. Add these constraints if needed:

```tcl
# Xilinx Vivado
set_false_path -from [get_cells u_elastic_buffer/gen_registered_output.skid_*]

# Intel Quartus
set_false_path -from [get_registers *elastic_buffer*skid*]
```
{% else %}
Combinational output mode prioritizes latency. Ensure paths meet timing:

```tcl
# Xilinx Vivado
set_max_delay -from [get_cells u_elastic_buffer/*] -to [get_cells downstream/*] {{ 1000 / metadata.fpga_resources[0].max_freq_mhz }}

# Intel Quartus
set_max_delay -from [get_registers *elastic_buffer*] -to [get_registers *downstream*] {{ 1000 / metadata.fpga_resources[0].max_freq_mhz }}
```
{% endif %}

## Monitoring Integration

The elastic buffer provides status signals for monitoring:

```systemverilog
// Connect to your monitoring infrastructure
assign perf_counters.fifo_fill_level = buffer_fill_level;
assign perf_counters.fifo_nearly_full = buffer_nearly_full;
assign alerts.backpressure_warning = buffer_nearly_full;
```

## Prerequisites

{% if metadata.prerequisites %}
{% for prereq in metadata.prerequisites %}
- {{ prereq }}
{% endfor %}
{% else %}
- No special prerequisites
{% endif %}

## Breaking Changes

{% if metadata.breaking_changes %}
{% for change in metadata.breaking_changes %}
- ⚠️ {{ change }}
{% endfor %}
{% else %}
- None expected
{% endif %}

## Known Limitations

{% if metadata.known_limitations %}
{% for limitation in metadata.known_limitations %}
- {{ limitation }}
{% endfor %}
{% else %}
- None documented
{% endif %}

## Verification Checklist

- [ ] All testbench scenarios pass
- [ ] Synthesis completes without critical warnings
- [ ] Timing closure achieved at target frequency
- [ ] Resource usage within budget
- [ ] Integration tests pass
- [ ] Latency measurements show expected improvement

## Rollback Plan

If issues occur, revert to original FIFO:

1. Replace elastic_buffer instantiation with original FIFO
2. Restore ready/valid handshake in producer
3. Remove monitoring connections

---

**⚠️ CANDIDATE FIX - Review Required Before Use**

This fix was automatically generated based on detected patterns. Human review is required before deployment to production systems.

For questions or issues, consult the Sentinel-HFT documentation.
