//==============================================================================
// Weighted Round-Robin Arbiter Testbench
//
// Generated by Sentinel-HFT FixPack Generator
// Template Version: 1.0.0
// Pattern: ARBITER_CONTENTION
//
// CANDIDATE FIX - Review Required Before Use
//==============================================================================

`timescale 1ns/1ps

module weighted_rr_arbiter_tb;

    //--------------------------------------------------------------------------
    // Parameters
    //--------------------------------------------------------------------------
    localparam int NUM_PORTS = {{ params.NUM_PORTS }};
    localparam int DATA_WIDTH = {{ params.DATA_WIDTH }};
    localparam int WEIGHT_WIDTH = {{ params.WEIGHT_WIDTH }};
    localparam bit ENABLE_ESCALATION = {{ '1' if params.ENABLE_PRIORITY_ESCALATION else '0' }};
    localparam int ESCALATION_THRESHOLD = {{ params.ESCALATION_THRESHOLD }};
    localparam bit SINGLE_CYCLE_GRANT = {{ '1' if params.SINGLE_CYCLE_GRANT else '0' }};

    localparam int CLK_PERIOD_NS = 10;
    localparam int NUM_TRANSACTIONS = {{ metadata.min_test_vectors }};

    //--------------------------------------------------------------------------
    // Signals
    //--------------------------------------------------------------------------
    logic                          clk;
    logic                          rst_n;
    logic [NUM_PORTS-1:0]          req;
    logic [NUM_PORTS-1:0][DATA_WIDTH-1:0] req_data;
    logic [NUM_PORTS-1:0]          grant;
    logic [NUM_PORTS-1:0][WEIGHT_WIDTH-1:0] weights;
    logic [DATA_WIDTH-1:0]         grant_data;
    logic                          grant_valid;
    logic                          grant_ready;
    logic [$clog2(NUM_PORTS)-1:0]  current_winner;
    logic [NUM_PORTS-1:0]          starvation_warning;

    //--------------------------------------------------------------------------
    // DUT
    //--------------------------------------------------------------------------
    weighted_rr_arbiter #(
        .NUM_PORTS(NUM_PORTS),
        .DATA_WIDTH(DATA_WIDTH),
        .WEIGHT_WIDTH(WEIGHT_WIDTH),
        .ENABLE_ESCALATION(ENABLE_ESCALATION),
        .ESCALATION_THRESHOLD(ESCALATION_THRESHOLD),
        .SINGLE_CYCLE_GRANT(SINGLE_CYCLE_GRANT)
    ) dut (.*);

    //--------------------------------------------------------------------------
    // Clock
    //--------------------------------------------------------------------------
    initial begin
        clk = 0;
        forever #(CLK_PERIOD_NS/2) clk = ~clk;
    end

    //--------------------------------------------------------------------------
    // Statistics
    //--------------------------------------------------------------------------
    int grant_count[NUM_PORTS];
    int total_grants;
    int total_cycles;
    int contention_cycles;

    //--------------------------------------------------------------------------
    // Test Tasks
    //--------------------------------------------------------------------------
    task reset_dut();
        rst_n <= 1'b0;
        req <= '0;
        req_data <= '0;
        grant_ready <= 1'b0;
        weights <= '0;
        for (int i = 0; i < NUM_PORTS; i++) begin
            weights[i] <= (i + 1);  // Default: port 0 = weight 1, port 1 = weight 2, etc.
        end
        repeat(10) @(posedge clk);
        rst_n <= 1'b1;
        repeat(5) @(posedge clk);
    endtask

    task reset_stats();
        for (int i = 0; i < NUM_PORTS; i++) grant_count[i] = 0;
        total_grants = 0;
        total_cycles = 0;
        contention_cycles = 0;
    endtask

    // Test 1: Single requester (fast path)
    task test_single_requester();
        $display("\n=== Test 1: Single Requester ===");
        reset_stats();
        grant_ready <= 1'b1;

        for (int i = 0; i < 100; i++) begin
            int port = $urandom_range(NUM_PORTS-1);
            req <= '0;
            req[port] <= 1'b1;
            req_data[port] <= $urandom();
            @(posedge clk);
            total_cycles++;

            if (grant[port]) begin
                grant_count[port]++;
                total_grants++;
            end
        end

        req <= '0;
        @(posedge clk);

        $display("  Total grants: %d / 100", total_grants);
        $display("  Single-requester latency: %s",
                 (total_grants >= 99) ? "PASS (1 cycle)" : "FAIL");
    endtask

    // Test 2: All ports contending
    task test_full_contention();
        $display("\n=== Test 2: Full Contention ===");
        reset_stats();
        grant_ready <= 1'b1;

        // All ports request
        for (int i = 0; i < NUM_PORTS; i++) begin
            req[i] <= 1'b1;
            req_data[i] <= i;
        end

        for (int c = 0; c < NUM_TRANSACTIONS; c++) begin
            @(posedge clk);
            total_cycles++;
            contention_cycles++;

            for (int i = 0; i < NUM_PORTS; i++) begin
                if (grant[i]) begin
                    grant_count[i]++;
                    total_grants++;
                end
            end
        end

        req <= '0;
        @(posedge clk);

        $display("  Grant distribution:");
        for (int i = 0; i < NUM_PORTS; i++) begin
            real expected_pct = 100.0 * weights[i] / (NUM_PORTS * (NUM_PORTS + 1) / 2);
            real actual_pct = 100.0 * grant_count[i] / total_grants;
            $display("    Port %0d: %0d grants (%0.1f%%, expected ~%0.1f%%)",
                     i, grant_count[i], actual_pct, expected_pct);
        end
    endtask

    // Test 3: Weight fairness
    task test_weight_fairness();
        $display("\n=== Test 3: Weight Fairness ===");
        reset_stats();

        // Set unequal weights: port 0 = 1, port 1 = 4
        weights[0] <= 1;
        weights[1] <= 4;
        for (int i = 2; i < NUM_PORTS; i++) weights[i] <= 1;
        @(posedge clk);

        grant_ready <= 1'b1;
        req[0] <= 1'b1;
        req[1] <= 1'b1;
        req_data[0] <= 'hAAAA;
        req_data[1] <= 'hBBBB;

        for (int c = 0; c < 1000; c++) begin
            @(posedge clk);
            for (int i = 0; i < 2; i++) begin
                if (grant[i]) grant_count[i]++;
            end
        end

        req <= '0;
        @(posedge clk);

        real ratio = real'(grant_count[1]) / grant_count[0];
        $display("  Port 0 grants: %d (weight 1)", grant_count[0]);
        $display("  Port 1 grants: %d (weight 4)", grant_count[1]);
        $display("  Ratio: %0.2f (expected ~4.0)", ratio);
        $display("  Weight fairness: %s", (ratio > 3.0 && ratio < 5.0) ? "PASS" : "FAIL");
    endtask

    // Test 4: Starvation prevention
    task test_starvation_prevention();
        $display("\n=== Test 4: Starvation Prevention ===");

        if (!ENABLE_ESCALATION) begin
            $display("  SKIPPED (escalation disabled)");
            return;
        end

        reset_stats();

        // High weight on port 0, low on others
        weights[0] <= 15;
        for (int i = 1; i < NUM_PORTS; i++) weights[i] <= 1;
        @(posedge clk);

        grant_ready <= 1'b1;
        req <= '1;  // All ports request

        int port1_wait = 0;
        int max_wait = 0;

        for (int c = 0; c < ESCALATION_THRESHOLD * 3; c++) begin
            @(posedge clk);

            if (!grant[1]) port1_wait++;
            else begin
                if (port1_wait > max_wait) max_wait = port1_wait;
                port1_wait = 0;
            end
        end

        req <= '0;
        @(posedge clk);

        $display("  Max wait for port 1: %d cycles", max_wait);
        $display("  Escalation threshold: %d", ESCALATION_THRESHOLD);
        $display("  Starvation prevented: %s",
                 (max_wait < ESCALATION_THRESHOLD * 2) ? "PASS" : "FAIL");
    endtask

    // Test 5: Consumer backpressure
    task test_backpressure();
        $display("\n=== Test 5: Consumer Backpressure ===");
        reset_stats();

        req[0] <= 1'b1;
        req_data[0] <= 'hDEAD;

        for (int c = 0; c < 50; c++) begin
            grant_ready <= (c % 3 != 0);  // 2/3 ready
            @(posedge clk);
            if (grant[0]) total_grants++;
        end

        req <= '0;
        grant_ready <= 1'b0;
        @(posedge clk);

        $display("  Grants with backpressure: %d / ~33", total_grants);
        $display("  Backpressure handling: %s",
                 (total_grants >= 30 && total_grants <= 36) ? "PASS" : "FAIL");
    endtask

    //--------------------------------------------------------------------------
    // Main Test
    //--------------------------------------------------------------------------
    initial begin
        $display("\n");
        $display("==============================================================");
        $display("  Weighted Round-Robin Arbiter Testbench");
        $display("  NUM_PORTS=%0d, WEIGHT_WIDTH=%0d", NUM_PORTS, WEIGHT_WIDTH);
        $display("==============================================================");

        reset_dut();

        test_single_requester();
        reset_dut();

        test_full_contention();
        reset_dut();

        test_weight_fairness();
        reset_dut();

        test_starvation_prevention();
        reset_dut();

        test_backpressure();

        $display("\n");
        $display("==============================================================");
        $display("  All tests completed");
        $display("==============================================================");
        $display("\n");

        $finish;
    end

    // Timeout
    initial begin
        #(CLK_PERIOD_NS * NUM_TRANSACTIONS * 20);
        $error("Global timeout!");
        $finish;
    end

endmodule
